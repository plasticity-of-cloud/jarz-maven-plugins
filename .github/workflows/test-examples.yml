name: Test Examples

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'examples/**'
      - '**/pom.xml'
  pull_request:
    branches: [ main ]
    paths:
      - 'examples/**'
      - '**/pom.xml'
  workflow_dispatch:

jobs:
  test-hello-jarz:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 11
      uses: actions/setup-java@v5
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Install JARZ plugins locally
      run: mvn clean install -DskipTests
      
    - name: Build Hello JARZ example
      working-directory: examples/hello-jarz
      run: mvn clean package
      
    - name: Test Hello JARZ execution
      working-directory: examples/hello-jarz
      run: |
        echo "Testing Hello JARZ application..."
        java -jar target/hello-jarz-1.0.0.jar > output.txt
        cat output.txt
        
        # Verify expected output
        if grep -q "Hello JARZ!" output.txt; then
          echo "✅ Hello JARZ application executed successfully"
        else
          echo "❌ Hello JARZ application failed"
          exit 1
        fi
        
        # Check if JARZ file was created
        if [ -f "target/hello-jarz-1.0.0.jarz" ]; then
          echo "✅ JARZ file created successfully"
          ls -la target/hello-jarz-1.0.0.*
        else
          echo "❌ JARZ file not created"
          exit 1
        fi
        
    - name: Upload example artifacts
      uses: actions/upload-artifact@v4
      with:
        name: hello-jarz-example
        path: |
          examples/hello-jarz/target/*.jar
          examples/hello-jarz/target/*.jarz
          examples/hello-jarz/output.txt
